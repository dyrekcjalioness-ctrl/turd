<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LIONESS â€” Kalendarz (08:00â€“20:00)</title>
<style>
:root{
  --bg:#071529; --panel:#0f2743; --muted:#9fb0d0; --accent:#f0b400;
  --green:#2ecc71; --purple:#8e44ad; --red:#e74c3c;
  --card-shadow: 0 10px 30px rgba(2,12,27,0.6);
  --radius:12px;
  --glass: rgba(255,255,255,0.03);
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:#fff;font-family:Inter, Arial, sans-serif;padding:18px;}
.container{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:520px 1fr;gap:20px;}
.panel{background:var(--panel);border-radius:var(--radius);padding:16px;box-shadow:var(--card-shadow);}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.btn{background:#0b3a63;border:none;color:#fff;padding:8px 10px;border-radius:8px;cursor:pointer}
.small{color:var(--muted);font-size:13px}
.weekdays{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;color:var(--muted);font-size:13px;margin-bottom:10px;text-align:center}
.grid{display:grid;grid-template-columns:repeat(7,1fr);gap:10px}
.cell{min-height:80px;border-radius:10px;padding:10px;position:relative;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);cursor:pointer;transition:transform .12s, box-shadow .12s}
.cell:hover{transform:translateY(-4px);box-shadow:0 8px 20px rgba(0,0,0,0.45)}
.daynum{font-weight:700;font-size:15px}
.slots-preview{position:absolute;left:10px;right:10px;bottom:10px;font-size:12px;opacity:.95}
.color-green{box-shadow: inset 0 0 0 2px rgba(46,204,113,0.08)}
.color-purple{box-shadow: inset 0 0 0 2px rgba(142,68,173,0.08)}
.color-red{box-shadow: inset 0 0 0 2px rgba(231,76,60,0.08)}
.right{display:flex;flex-direction:column;gap:12px}
.hours-wrap{display:block;max-height:calc(100vh - 200px);overflow:auto;padding-right:6px}
.hour-row{display:flex;align-items:flex-start;justify-content:space-between;padding:8px;border-radius:8px;margin-bottom:8px;background:var(--glass)}
.hour-time{width:80px;opacity:.95;font-weight:700}
.hour-info{flex:1;padding:6px 10px;border-radius:8px;background:transparent;margin-left:10px;display:flex;flex-direction:column;gap:6px}
.hour-top{display:flex;justify-content:space-between;align-items:center}
.hour-name{font-weight:700}
.hour-bottom{display:flex;flex-wrap:wrap;gap:10px;color:var(--muted);font-size:13px}
.add-btn{background:#0a84ff;padding:6px 10px;border-radius:8px;color:#fff;border:none;cursor:pointer}
.edit-btn{background:#ffb86b;padding:6px 10px;border-radius:8px;color:#000;border:none;cursor:pointer}
.del-btn{background:#b83b3b;padding:6px 10px;border-radius:8px;color:#fff;border:none;cursor:pointer}
.form{margin-top:10px;padding:12px;border-radius:8px;background:rgba(255,255,255,0.02)}
.input{width:100%;padding:9px;border-radius:8px;border:0;background:rgba(255,255,255,0.03);color:#fff;margin-bottom:8px}
.row{display:flex;gap:8px}
.row .input{flex:1}
.controls{display:flex;gap:8px;justify-content:flex-end}
.save{background:var(--accent);border:none;padding:8px 12px;border-radius:8px;color:#000;font-weight:700;cursor:pointer}
.cancel{background:#4b6b8f;border:none;padding:8px 12px;border-radius:8px;color:#fff;cursor:pointer}
.note{font-size:13px;color:var(--muted)}
.top-actions{display:flex;gap:8px;align-items:center}
.exportarea{display:flex;gap:6px;align-items:center}
.tooltip{font-size:12px;color:var(--muted);margin-left:8px}
@media (max-width:980px){.container{grid-template-columns:1fr} .hours-wrap{max-height:300px}}
</style>
</head>
<body>
<div class="container">
  <!-- LEFT: Month calendar -->
  <div class="panel">
    <div class="header">
      <div class="top-actions">
        <button id="prev" class="btn">â€¹</button>
        <div style="text-align:center">
          <div id="monthTitle" style="font-weight:800;font-size:18px">MiesiÄ…c Rok</div>
          <div class="small">kliknij datÄ™ â†’ po prawej wyÅ›wietlÄ… siÄ™ godziny</div>
        </div>
        <button id="next" class="btn">â€º</button>
      </div>
      <div class="exportarea">
        <button id="exportBtn" class="btn" title="Eksportuj caÅ‚y kalendarz">Eksport</button>
        <button id="importBtn" class="btn" title="Importuj dane JSON">Import</button>
        <input id="fileInput" type="file" accept=".json" style="display:none">
      </div>
    </div>

    <div class="weekdays" id="weekdaysRow">
      <div>Pn</div><div>Wt</div><div>Åšr</div><div>Cz</div><div>Pt</div><div>So</div><div>Nd</div>
    </div>
    <div id="calendarGrid" class="grid"></div>
  </div>

  <!-- RIGHT: Hours + form -->
  <div class="right">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div>
          <div style="font-weight:700" id="selectedDateLabel">Wybierz datÄ™</div>
          <div class="note" id="slotsSummary"> </div>
        </div>
        <div class="note" id="liveNote">lokalnie</div>
      </div>

      <div class="hours-wrap" id="hoursWrap">
        <!-- hours rows inserted here -->
      </div>

      <div id="formPanel" class="form" style="display:none">
        <div style="font-weight:800;margin-bottom:8px" id="formTimeLabel">08:00</div>
        <input class="input" id="inpName" placeholder="ImiÄ™ i nazwisko">
        <input class="input" id="inpPhone" placeholder="Telefon">
        <div class="row">
          <input class="input" id="inpReg" placeholder="Nr rejestracyjny">
          <input class="input" id="inpAddr" placeholder="Adres">
        </div>
        <input class="input" id="inpNote" placeholder="Notatki">
        <div class="controls" style="margin-top:8px">
          <button id="deleteBtn" class="del-btn" style="display:none">UsuÅ„</button>
          <button id="cancelBtn" class="cancel">Anuluj</button>
          <button id="saveBtn" class="save">Zapisz</button>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
/* ====== USTAWIENIA ====== */
const START_H = 8;
const END_H = 20; // includes 20:00
const HOURS = [];
for(let h=START_H; h<=END_H; h++){
  HOURS.push(`${String(h).padStart(2,'0')}:00`);
  if(h < END_H) HOURS.push(`${String(h).padStart(2,'0')}:30`);
}
const LS_PREFIX = 'lioness_local__'; // localStorage key prefix

/* DOM */
const calendarGrid = document.getElementById('calendarGrid');
const monthTitle = document.getElementById('monthTitle');
const prevBtn = document.getElementById('prev'), nextBtn = document.getElementById('next');
const selectedDateLabel = document.getElementById('selectedDateLabel');
const hoursWrap = document.getElementById('hoursWrap');
const slotsSummary = document.getElementById('slotsSummary');
const liveNote = document.getElementById('liveNote');

const formPanel = document.getElementById('formPanel');
const formTimeLabel = document.getElementById('formTimeLabel');
const inpName = document.getElementById('inpName');
const inpPhone = document.getElementById('inpPhone');
const inpReg = document.getElementById('inpReg');
const inpAddr = document.getElementById('inpAddr');
const inpNote = document.getElementById('inpNote');
const saveBtn = document.getElementById('saveBtn');
const cancelBtn = document.getElementById('cancelBtn');
const deleteBtn = document.getElementById('deleteBtn');

const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const fileInput = document.getElementById('fileInput');

let cur = new Date();
let selectedKey = null;
let selectedTime = null;

/* POLSKIE MIESIÄ„CE */
const monthsPL = ["StyczeÅ„","Luty","Marzec","KwiecieÅ„","Maj","Czerwiec","Lipiec","SierpieÅ„","WrzesieÅ„","PaÅºdziernik","Listopad","GrudzieÅ„"];

/* HELPERS LS */
function lsKey(dateKey){ return LS_PREFIX + dateKey; }
function saveDayLocal(dateKey, dataObj){
  localStorage.setItem(lsKey(dateKey), JSON.stringify(dataObj));
}
function loadDayLocal(dateKey){
  const raw = localStorage.getItem(lsKey(dateKey));
  return raw ? JSON.parse(raw) : {};
}
function deleteDayLocal(dateKey){
  localStorage.removeItem(lsKey(dateKey));
}

/* CALENDAR RENDER */
function renderMonth(){
  calendarGrid.innerHTML = '';
  cur.setDate(1);
  const month = cur.getMonth(), year = cur.getFullYear();
  monthTitle.textContent = monthsPL[month] + ' ' + year;

  const firstDay = (new Date(year, month, 1).getDay() + 6) % 7; // Monday as 0
  const last = new Date(year, month+1, 0).getDate();

  // leading blanks
  for(let i=0;i<firstDay;i++) calendarGrid.appendChild(document.createElement('div'));

  // days
  for(let d=1; d<=last; d++){
    const cell = document.createElement('div');
    cell.className = 'cell panel';
    const daynum = document.createElement('div'); daynum.className='daynum'; daynum.textContent = d;
    const preview = document.createElement('div'); preview.className='slots-preview small'; preview.textContent = '';
    cell.appendChild(daynum); cell.appendChild(preview);
    const key = `${d}.${month+1}.${year}`;
    cell.dataset.key = key;

    // count local entries to color
    const obj = loadDayLocal(key) || {};
    const cnt = Object.keys(obj).length;
    if(cnt === 0) { /* nothing */ }
    else if(cnt <= 2) cell.classList.add('color-green');
    else if(cnt >= HOURS.length) cell.classList.add('color-red');
    else if(cnt >= Math.ceil(HOURS.length/2)) cell.classList.add('color-purple');
    else cell.classList.add('color-green');
    if(cnt) preview.textContent = `${cnt} zapis(Ã³w)`;

    cell.addEventListener('click', ()=> openDate(key,d,month+1,year));
    calendarGrid.appendChild(cell);
  }
}

/* OPEN DATE */
function openDate(dateKey, d, m, y){
  selectedKey = dateKey;
  selectedDateLabel.textContent = `Data: ${dateKey}`;
  renderHoursSkeleton();
  renderHoursWithData(loadDayLocal(dateKey));
}

/* HOURS SKELETON ALWAYS */
function renderHoursSkeleton(){
  hoursWrap.innerHTML = '';
  formPanel.style.display = 'none';
  selectedTime = null;
  HOURS.forEach(time=>{
    const row = document.createElement('div'); row.className='hour-row';
    const timeCol = document.createElement('div'); timeCol.className='hour-time'; timeCol.innerText=time;
    const info = document.createElement('div'); info.className='hour-info';
    const top = document.createElement('div'); top.className='hour-top';
    const namePlaceholder = document.createElement('div'); namePlaceholder.className='hour-name'; namePlaceholder.innerText='';
    const right = document.createElement('div');
    const addBtn = document.createElement('button'); addBtn.className='add-btn'; addBtn.innerText='âž•';
    addBtn.onclick = ()=> openFormFor(time, null);
    right.appendChild(addBtn);
    top.appendChild(namePlaceholder); top.appendChild(right);
    const bottom = document.createElement('div'); bottom.className='hour-bottom';
    info.appendChild(top); info.appendChild(bottom);
    row.appendChild(timeCol); row.appendChild(info);
    hoursWrap.appendChild(row);
  });
  slotsSummary.textContent = '';
}

/* RENDER HOURS WITH DATA */
function renderHoursWithData(data){
  hoursWrap.innerHTML = '';
  let cnt=0;
  HOURS.forEach(time=>{
    const row = document.createElement('div'); row.className='hour-row';
    const timeCol = document.createElement('div'); timeCol.className='hour-time'; timeCol.innerText=time;
    const info = document.createElement('div'); info.className='hour-info';

    if(data && data[time]){
      cnt++;
      const c = data[time];
      const top = document.createElement('div'); top.className='hour-top';
      const nameDiv = document.createElement('div'); nameDiv.className='hour-name'; nameDiv.innerText = c.name || '';
      const btns = document.createElement('div');
      const editBtn = document.createElement('button'); editBtn.className='edit-btn'; editBtn.innerText='Edytuj';
      const delBtn = document.createElement('button'); delBtn.className='del-btn'; delBtn.innerText='UsuÅ„';
      editBtn.onclick = ()=> openFormFor(time, c);
      delBtn.onclick = ()=> { if(confirm('UsuÅ„ wpis?')){ delete data[time]; saveDayLocal(selectedKey, data); renderHoursWithData(data); renderMonth(); } };
      btns.appendChild(editBtn); btns.appendChild(delBtn);
      top.appendChild(nameDiv); top.appendChild(btns);

      const bottom = document.createElement('div'); bottom.className='hour-bottom';
      if(c.phone) { const s=document.createElement('span'); s.textContent = `ðŸ“ž ${c.phone}`; bottom.appendChild(s); }
      if(c.reg) { const s=document.createElement('span'); s.textContent = `ðŸš— ${c.reg}`; bottom.appendChild(s); }
      if(c.addr) { const s=document.createElement('span'); s.textContent = `ðŸ  ${c.addr}`; bottom.appendChild(s); }
      if(c.note) { const s=document.createElement('span'); s.textContent = `ðŸ“ ${c.note}`; bottom.appendChild(s); }

      info.appendChild(top); info.appendChild(bottom);
    } else {
      const top = document.createElement('div'); top.className='hour-top';
      const nameDiv = document.createElement('div'); nameDiv.className='hour-name'; nameDiv.innerText = '';
      const right = document.createElement('div');
      const addBtn = document.createElement('button'); addBtn.className='add-btn'; addBtn.innerText='âž•';
      addBtn.onclick = ()=> openFormFor(time, null);
      right.appendChild(addBtn);
      top.appendChild(nameDiv); top.appendChild(right);
      const bottom = document.createElement('div'); bottom.className='hour-bottom';
      info.appendChild(top); info.appendChild(bottom);
    }

    row.appendChild(timeCol); row.appendChild(info);
    hoursWrap.appendChild(row);
  });

  slotsSummary.textContent = `${cnt}/${HOURS.length} zajÄ™tych`;
}

/* OPEN FORM FOR given time; oldData null => add */
function openFormFor(time, oldData){
  selectedTime = time;
  formTimeLabel.innerText = time;
  formPanel.style.display = 'block';
  inpName.value = oldData?.name || '';
  inpPhone.value = oldData?.phone || '';
  inpReg.value = oldData?.reg || '';
  inpAddr.value = oldData?.addr || '';
  inpNote.value = oldData?.note || '';
  deleteBtn.style.display = oldData ? 'inline-block' : 'none';
}

/* SAVE */
saveBtn.addEventListener('click', ()=>{
  if(!selectedKey || !selectedTime){ alert('Wybierz datÄ™ i godzinÄ™'); return; }
  const name = inpName.value.trim();
  const phone = inpPhone.value.trim();
  if(!name || !phone){ alert('Wpisz ImiÄ™ i numer telefonu'); return; }
  const reg = inpReg.value.trim();
  const addr = inpAddr.value.trim();
  const note = inpNote.value.trim();

  const day = loadDayLocal(selectedKey);
  day[selectedTime] = { name, phone, reg, addr, note };
  saveDayLocal(selectedKey, day);
  formPanel.style.display = 'none';
  renderHoursWithData(day);
  renderMonth(); // refresh colors/previews
});

/* CANCEL */
cancelBtn.addEventListener('click', ()=>{ formPanel.style.display='none'; });

/* DELETE */
deleteBtn.addEventListener('click', ()=>{
  if(!selectedKey || !selectedTime) return;
  if(!confirm('UsuÅ„ wpis?')) return;
  const day = loadDayLocal(selectedKey);
  if(day[selectedTime]) delete day[selectedTime];
  saveDayLocal(selectedKey, day);
  formPanel.style.display='none';
  renderHoursWithData(day);
  renderMonth();
});

/* EXPORT / IMPORT */
exportBtn.addEventListener('click', ()=>{
  // build object of all keys starting with prefix
  const out = {};
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if(k.startsWith(LS_PREFIX)){
      out[k.replace(LS_PREFIX,'')] = JSON.parse(localStorage.getItem(k));
    }
  }
  const blob = new Blob([JSON.stringify(out, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'lioness_calendar_export.json'; a.click();
  URL.revokeObjectURL(url);
});

importBtn.addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = ()=> {
    try{
      const json = JSON.parse(reader.result);
      // merge into localStorage (ask user)
      if(!confirm('ZaimportowaÄ‡ dane i nadpisaÄ‡ lokalne wpisy?')) return;
      Object.keys(json).forEach(k=>{
        saveDayLocal(k, json[k]);
      });
      alert('Import zakoÅ„czony');
      renderMonth();
      if(selectedKey) renderHoursWithData(loadDayLocal(selectedKey));
    }catch(err){ alert('BÅ‚Ä™dny plik JSON'); }
  };
  reader.readAsText(f);
});

/* NAV */
prevBtn.addEventListener('click', ()=>{ cur.setMonth(cur.getMonth()-1); renderMonth(); });
nextBtn.addEventListener('click', ()=>{ cur.setMonth(cur.getMonth()+1); renderMonth(); });

/* INIT */
renderMonth();
/* auto-open today */
(function(){
  const td = new Date();
  const key = `${td.getDate()}.${td.getMonth()+1}.${td.getFullYear()}`;
  // simulate click to open date
  const cells = document.querySelectorAll('#calendarGrid .cell');
  for(const c of cells) if(c.dataset.key === key){ c.click(); break; }
})();
</script>
</body>
</html>
